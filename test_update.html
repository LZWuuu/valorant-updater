<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Update Logic</title>
</head>
<body>
    <h1>Testing Update Logic</h1>
    <div id="results"></div>

    <script type="module">
        const resultsDiv = document.getElementById('results');

        async function testUpdate() {
            try {
                // 1. Load config
                resultsDiv.innerHTML += '<h3>1. Loading Config...</h3>';
                const configRes = await fetch('/api/config');
                const config = await configRes.json();
                resultsDiv.innerHTML += `<p>Repo: ${config.repo}</p>`;
                resultsDiv.innerHTML += `<p>Branch: ${config.branch}</p>`;

                // 2. Load current user.json from GitHub
                resultsDiv.innerHTML += '<h3>2. Loading current user.json from GitHub...</h3>';
                const userUrl = `https://api.github.com/repos/${config.repo}/contents/${config.userDataPath}?ref=${config.branch}`;
                const userRes = await fetch(userUrl, {
                    headers: { "Authorization": `token ${config.token}` }
                });

                let userJson = { players: [], newestMatchID: null };
                if (userRes.ok) {
                    const userData = await userRes.json();
                    const decodedContent = atob(userData.content.replace(/\s/g, ''));
                    userJson = JSON.parse(decodedContent);
                    resultsDiv.innerHTML += `<p>Current newest match ID: ${userJson.newestMatchID}</p>`;
                    resultsDiv.innerHTML += `<p>Players count: ${userJson.players.length}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p style="color: red">Failed to load user.json: ${userRes.status}</p>`;
                }

                // 3. Fetch recent matches from Henrik API
                resultsDiv.innerHTML += '<h3>3. Fetching recent matches from Henrik API...</h3>';
                const henrikRes = await fetch('/api/henrik?size=10');
                const matchData = await henrikRes.json();

                if (matchData && matchData.data) {
                    resultsDiv.innerHTML += `<p>Total matches fetched: ${matchData.data.length}</p>`;

                    // 4. Filter custom matches
                    const customMatches = matchData.data.filter(match => {
                        const mode = match?.metadata?.mode;
                        const isCustom = (mode === "custom");

                        if (!isCustom) return false;

                        const matchPlayers = match.players?.all_players || [];
                        const matchPlayerPuuids = matchPlayers.map(p => p.puuid);
                        const userPlayerPuuids = userJson.players.map(p => p.puuid);

                        const allPlayersInUserList = matchPlayerPuuids.every(puuid =>
                            userPlayerPuuids.includes(puuid)
                        );

                        if (!allPlayersInUserList) return false;

                        const playerCount = matchPlayerPuuids.length;
                        return playerCount === 8 || playerCount === 6;
                    });

                    resultsDiv.innerHTML += `<p>Custom matches found: ${customMatches.length}</p>`;

                    // 5. Check if there are new matches
                    if (customMatches.length > 0) {
                        const latestMatch = customMatches[0];
                        const latestMatchId = latestMatch.metadata?.matchid;

                        resultsDiv.innerHTML += '<h3>4. Comparison:</h3>';
                        resultsDiv.innerHTML += `<p>Latest match ID from API: ${latestMatchId}</p>`;
                        resultsDiv.innerHTML += `<p>Current newest match ID in GitHub: ${userJson.newestMatchID}</p>`;

                        if (latestMatchId !== userJson.newestMatchID) {
                            resultsDiv.innerHTML += `<p style="color: green"><b>New matches available! Should trigger update.</b></p>`;

                            // Count new matches
                            const newMatches = [];
                            for (const match of customMatches) {
                                if (match.metadata?.matchid === userJson.newestMatchID) break;
                                newMatches.push(match);
                            }
                            resultsDiv.innerHTML += `<p>Number of new matches: ${newMatches.length}</p>`;

                            // List new match IDs
                            resultsDiv.innerHTML += '<h4>New match IDs:</h4><ul>';
                            newMatches.forEach((match, i) => {
                                resultsDiv.innerHTML += `<li>${i+1}. ${match.metadata?.matchid}</li>`;
                            });
                            resultsDiv.innerHTML += '</ul>';

                        } else {
                            resultsDiv.innerHTML += `<p style="color: orange">No new matches. Data is up to date.</p>`;
                        }
                    } else {
                        resultsDiv.innerHTML += `<p style="color: red">No valid custom matches found!</p>`;
                    }

                    // 6. Debug: Show all match details
                    resultsDiv.innerHTML += '<h3>5. All Matches Debug Info:</h3>';
                    matchData.data.slice(0, 5).forEach((match, i) => {
                        const mode = match?.metadata?.mode;
                        const playerCount = match.players?.all_players?.length || 0;
                        const matchId = match?.metadata?.matchid;
                        resultsDiv.innerHTML += `<p>${i+1}. ${matchId} - Mode: ${mode}, Players: ${playerCount}</p>`;
                    });

                } else {
                    resultsDiv.innerHTML += `<p style="color: red">Failed to fetch match data</p>`;
                }

            } catch (error) {
                resultsDiv.innerHTML += `<h3 style="color: red">Error: ${error.message}</h3>`;
                console.error(error);
            }
        }

        // Run the test
        testUpdate();
    </script>
</body>
</html>